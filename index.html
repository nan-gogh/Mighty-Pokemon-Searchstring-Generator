<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Mächtiger Suchstring Generator</title>
  <link rel="icon" href="./mighty_mark_go.svg" type="image/svg+xml" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --color-bg-dark-teal: #12251d;
  --color-bg-charcoal: #0f1011;
  --color-lime-bright: #d5ff9a;
  --color-teal-primary: rgb(97, 196, 151);
  --color-charcoal-dark: #1a1b1c;
  --color-border-subtle: rgba(255,255,255,0.03);
  --color-focus-blue: rgba(78, 144, 254, 0.12);
  --header-control-effective: clamp(min(140px, 95vw), 85vw, 300px);
  --radius: 999px;
  --transition-smooth: 520ms cubic-bezier(.2,0,.2,1);
  --transition-fast: 120ms ease;
  --font-display: 'Orbitron', Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  --font-mono: 'Space Grotesk', ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
  --lime: 213,255,154;
  --teal: 97,196,151;
  --lime-100: rgba(var(--lime),1);
  --lime-95: rgba(var(--lime),.95);
  --lime-60: rgba(var(--lime),.6);
  --lime-55: rgba(var(--lime),.55);
  --lime-40: rgba(var(--lime),.4);
  --lime-16: rgba(var(--lime),.16);
  --lime-14: rgba(var(--lime),.14);
  --lime-10: rgba(var(--lime),.1);
  --lime-08: rgba(var(--lime),.08);
  --lime-06: rgba(var(--lime),.06);
  --glow-subtle: rgba(var(--lime),.12);
  --glow-mid: rgba(var(--teal),.06);
  --glow-strong: rgba(var(--lime),.8);
  --glow-strong-teal: rgba(var(--teal),.8);
  --mini-count: 10;
  --mini-dur: 1s;
  --mini-size-min: 4px;
  --mini-size-max: 24px;
  --mini-horizontal-spread-mult: 0.5;
  --mini-vertical-spread-mult: 0.5;
  --mini-jitter-x: 30px;
  --mini-jitter-y: 24px;
  --mini-spawn-down-ratio: 0.06;
  --mini-spawn-nudge-ratio: 0.06;
  --mini-blur: 3px;
  --particles-count: 12;
  --particles-dur-min: 6s;
  --particles-dur-max: 14s;
  --particles-size-min: 8px;
  --particles-size-max: 30px;
  --particles-drift-max: 120px;
  --particles-delay-range: 10s;
  --particles-blur: 6px;
  --particles-opacity-peak: 1;
  --particles-travel-vh: 640vh;
  --bottom-pulse-height: 50vh;
  --bottom-pulse-opacity: 0.5;
  --bottom-pulse-duration: 3800ms;
  --bottom-pulse-max: 100vh;
}

/* Text selection styling — match the site's lime/teal theme.
   Use CSS variables so users can tweak selection colors in :root. */
::selection{ background: var(--color-teal-primary); color: var(--color-lime-bright); }
::-moz-selection{ background: var(--color-teal-primary); color: var(--color-lime-bright); }

/* Also ensure selection inside form controls (textarea/input) uses same colors */
textarea::selection, input::selection, select::selection{
  background: var(--color-teal-primary);
  color: var(--color-lime-bright);
}

/* Bottom pulse: a subtle animated linear gradient rising from the viewport bottom */
.bottom-pulse{
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  height: var(--bottom-pulse-height, 22vh);
  pointer-events: none;
  z-index: 0;
  background: linear-gradient(to top, var(--color-lime-bright) 0%, rgba(213,255,154,0.66) 18%, rgba(213,255,154,0.18) 36%, transparent 100%);
  opacity: 0;
  will-change: height, opacity;
  mix-blend-mode: screen;
  filter: blur(14px);
  animation: bottom-pulse-anim var(--bottom-pulse-duration, 3800ms) ease-in-out infinite;
}

@keyframes bottom-pulse-anim{
  0%{ height: var(--bottom-pulse-height, 50vh); opacity: 0.25; }
  /*20%{ height: calc(var(--bottom-pulse-max, 50vh) * 0.5); opacity: calc(var(--bottom-pulse-opacity, 0.14) * 0.5); }*/
  50%{ height: var(--bottom-pulse-max, 100vh); opacity: 0.75; }
  /*80%{ height: calc(var(--bottom-pulse-max, 50vh) * 0.5); opacity: calc(var(--bottom-pulse-opacity, 0.14) * 0.45); }*/
  100%{ height: var(--bottom-pulse-height, 50vh); opacity: 0.25; }
}

@media (prefers-reduced-motion: reduce){
  .bottom-pulse{ animation: none; opacity: var(--bottom-pulse-opacity, 0.14); height: var(--bottom-pulse-height, 50vh); }
}

/* Animated diagonal grid background */
.grid-background{
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 0;
  overflow: hidden;
  opacity: 0.15;
}

.grid-background::before,
.grid-background::after{
  content: "";
  position: absolute;
  inset: -50%;
  background-image: 
    repeating-linear-gradient(
      45deg,
      transparent,
      transparent 40px,
      var(--color-teal-primary) 40px,
      var(--color-teal-primary) 41px,
      transparent 41px,
      transparent 80px
    ),
    repeating-linear-gradient(
      -45deg,
      transparent,
      transparent 40px,
      var(--color-lime-bright) 40px,
      var(--color-lime-bright) 41px,
      transparent 41px,
      transparent 80px
    );
  animation: grid-pulse 8s ease-in-out infinite;
}

.grid-background::after{
  animation-delay: -4s;
  opacity: 0.5;
}

@keyframes grid-pulse{
  0%, 100%{ opacity: 0.3; transform: scale(1); }
  50%{ opacity: 0.6; transform: scale(1.05); }
}

/* Quick glitch effect applied when user toggles language */
.grid-background.glitch::before,
.grid-background.glitch::after{
  animation: grid-pulse 8s ease-in-out infinite, bg-glitch 520ms steps(6, end) 1;
  filter: hue-rotate(8deg) saturate(1.15);
}

@keyframes bg-glitch{
  0% { transform: translateX(0) translateY(0) scale(1); clip-path: inset(0 0 0 0); }
  10% { transform: translateX(-6px) translateY(-2px) scale(1.02); clip-path: inset(4% 0 0 0); }
  20% { transform: translateX(8px) translateY(3px) scale(0.99); clip-path: inset(0 6% 0 0); }
  30% { transform: translateX(-4px) translateY(2px) scale(1.01); clip-path: inset(0 0 6% 0); }
  45% { transform: translateX(6px) translateY(-3px) scale(1); clip-path: inset(6% 0 0 0); }
  60% { transform: translateX(-8px) translateY(1px) scale(1.02); clip-path: inset(0 0 0 8%); }
  80% { transform: translateX(2px) translateY(-1px) scale(1); clip-path: inset(0 0 0 0); }
  100% { transform: translateX(0) translateY(0) scale(1); clip-path: inset(0 0 0 0); }
}

@media (prefers-reduced-motion: reduce){
  .grid-background::before,
  .grid-background::after{
    animation: none;
    opacity: 0.4;
  }
}

html{box-sizing:border-box}
*,*::before,*::after{box-sizing:inherit}

html,body{
  height:100%;
  margin:0;
  font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  touch-action: pan-x pan-y;
  -ms-touch-action: pan-x pan-y;
}

body{
  background:var(--color-bg-dark-teal);
  color:var(--color-teal-primary);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  position:relative;
  z-index:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  min-height:100vh;
  padding:clamp(12px, 3vw, 28px);
  padding-top: 80px;
  box-sizing:border-box;
}

body.centered{
  justify-content: center;
  padding-top: 80px;
}

/* Radial glow positioned at crown location, covering full viewport without clipping */
body::after{
  content: "";
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 0;
  background: radial-gradient(circle at var(--glow-x, 50%) var(--glow-y, 30%), var(--color-teal-primary) 0%, var(--color-teal-primary) 10%, var(--lime-16) 20%, transparent 35%);
  filter: blur(14px);
  opacity: 0.95;
}

body > *{position:relative;z-index:1}

header{
  background: transparent;
  color:var(--color-teal-primary); 
  padding:clamp(8px, 2.5vw, 18px) 0 clamp(4px, 1vw, 6px) 0;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:clamp(6px, 2vw, 10px);
  position:relative;
  width:100%;
  max-width:min(980px, 95vw);
}

.header-svg-container{
  position: relative;
  width: var(--header-control-effective);
  height: auto;
  aspect-ratio: 188.38 / 148.46;
  flex: 0 0 auto;
  max-width: 92vw;
  --header-y-offset: 0px;
  transform: translateY(var(--header-y-offset));
}

.header-crown, .header-energy{
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  border-radius: 0;
  filter: drop-shadow(0 0 20px var(--color-lime-bright));
  transform-origin: center;
  transform-box: fill-box;
  will-change: transform, filter;
}

.header-crown{
  z-index: 10001;
  --bob-offset: -6%;
  --svg-scale: 0.6;
  animation: img-bob 4s ease-in-out infinite;
  filter: drop-shadow(0 0 10px var(--color-lime-bright)) drop-shadow(0 0 30px var(--lime-40));
}

/* Energy particle container - optimized for mobile performance */
.energy-particles{
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 0;
  overflow: visible;
  /* Add glow via box-shadow on container instead of filter on each particle */
  filter: drop-shadow(0 0 8px var(--color-lime-bright)) drop-shadow(0 0 20px var(--lime-40));
}

/* Individual energy particle */
.energy-particle{
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  opacity: 0;
  transform: translateY(var(--energy-offset, 20%)) scale(0);
  will-change: transform, opacity;
  animation: energy-pop 4s ease-out infinite;
  top: 15%;
  z-index: 1;
}


.header-actions{
  display:flex;
  flex-direction:column;
  gap:clamp(6px, 1.5vw, 8px);
  align-items:center;
  justify-content:center;
  margin-top:clamp(20px, 20vw, 65px);
  position:relative;
  width:100%;
}

.header-actions .btn{
  padding:clamp(8px, 2vw, 10px) clamp(14px, 3vw, 18px);
  border-radius:var(--radius);
  /* match the card width so buttons visually enclose the card */
  width: var(--header-control-effective);
  max-width:100%;
  display:block;
  margin:0 auto;
}

h1{
  margin: clamp(8px, 2vw, 12px) auto 0 auto;
  font-family: var(--font-display);
  font-size: clamp(12px, calc(var(--header-control-effective) * 0.07), 40px);
  font-weight:600;
  text-align:center;
  white-space: normal;
  overflow: visible;
  width: var(--header-control-effective);
  max-width: 100%;
  box-sizing: border-box;
  padding: 0;
  line-height:1.15;
  padding-bottom: clamp(4px, 1vw, 6px);
  letter-spacing: 0.1em;
  -webkit-text-stroke: 0.25px var(--color-lime-bright);
  text-shadow: -0.6px -0.6px 0 var(--color-lime-bright), 0.6px -0.6px 0 var(--color-lime-bright), -0.6px 0.6px 0 var(--color-lime-bright), 0.6px 0.6px 0 var(--color-lime-bright), 0 0 20px var(--color-lime-bright), 0 0 30px var(--lime-40);
  animation: unified-glow 3s ease-in-out infinite;
}

header h1:first-of-type{
  font-size: clamp(16px, calc(var(--header-control-effective) * 0.07), 48px);
  margin-bottom: clamp(6px, 2vw, 12px);
}

header h2{
  font-size:clamp(16px, 4.5vw, 36px);
  margin:0 auto;
  font-weight:600;
  color:var(--color-teal-primary);
  text-align:center;
  width:100%;
  max-width:var(--header-control-effective);
  box-sizing:border-box;
  line-height:1.2;
}

.p-muted{
  color:var(--color-teal-primary);
  margin:0 0 clamp(6px, 1.5vw, 8px) 0;
  font-size:clamp(0.85rem, 2vw, 0.95rem);
}

.p-muted.small{
  display:block;
  width:100%;
  max-width:var(--header-control-effective);
  margin:clamp(8px, 2vw, 12px) auto 0;
  text-align:center;
  font-size: clamp(11px, 2.5vw, 14px);
  line-height: 1.4;
  padding:0 clamp(8px, 2vw, 12px);
}

.card{
  background:var(--color-lime-bright);
    padding:clamp(25px, 4vw, 35px) clamp(12px, 3vw, 18px) clamp(25px, 3vw, 18px) clamp(12px, 3vw, 18px);
    margin-bottom:clamp(10px, 2.5vw, 16px);
  /* reduce top spacing so the clipboard button sits closer to the headline */
  margin-top: 8px;
  border:none;
  position:relative;
  z-index:1;
  width: var(--header-control-effective);
  max-width: 100%;
  margin-left: auto;
  margin-right: auto;
  max-height: 1200px;
  overflow: visible;
  opacity: 1;
  transform: translateY(0);
  transition: max-height var(--transition-smooth), opacity 420ms ease, transform 420ms ease, padding 420ms ease, margin 420ms ease;
  will-change: transform;
  display:flex;
  flex-direction:column;
  justify-content:center; /* center textarea vertically between the anchored buttons */
  align-items:stretch;
  gap: clamp(10px, 2vw, 14px);
  /* steady glow to match header/controls (no pulsation) */
  box-shadow: 0 0 72px var(--glow-strong-teal), 0 0 40px var(--glow-strong);
}

textarea{
  width:100%;
  min-height:clamp(140px, 30vw, 220px);
  max-height:clamp(50vh, 70vh, 80vh);
  /* symmetric vertical / horizontal padding to avoid visual horizontal shift on narrow screens */
  padding: 0;
  margin-top: clamp(20px, 4vw, 30px);
  margin-left: clamp(2px, 0vw, 5px);
    border:none;
    background:var(--color-lime-bright);
    color:var(--color-teal-primary);
    /* Prefer Space Grotesk (variable) for textarea content; fallback stack kept in --font-mono */
    font-family: var(--font-mono);
    font-variant-numeric: tabular-nums;
  font-size:clamp(11px, 2vw, 13px);
  resize:none;
  white-space:pre-wrap;
  word-break:break-word;
  overflow:auto;
  overflow-wrap: anywhere;
  /* hide visible scrollbars but keep scrolling functional */
  -ms-overflow-style: none; /* IE/Edge */
  scrollbar-width: none; /* Firefox */
}

textarea:focus{
  outline:none;
  box-shadow:none;
}

/* hide webkit scrollbar */
textarea::-webkit-scrollbar{ width:0; height:0; }

.btn{
  background: var(--color-teal-primary);
  color: var(--color-lime-bright);
  padding:clamp(8px, 2vw, 10px) clamp(12px, 2.5vw, 14px);
  border-radius:var(--radius);
  border:none;
  font-weight:600;
  font-size:clamp(0.85rem, 2vw, 1rem);
  cursor:pointer;
  transition:transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), color var(--transition-fast);
  box-shadow:none;
}

/* Shared display/align properties for anchored buttons to avoid duplication */
.btn, .btn-clipboard, #mode-info-btn{
  display: inline-flex;
  justify-content: center;
  align-items: center;
  text-align: center;
  border-radius: var(--radius);
  box-sizing: border-box;
  transform-origin: center;
  will-change: transform;
  /* anchor transform used by shared keyframes; default is no translate */
  --anchor: translateY(0);
  transform: var(--anchor);
}

.btn:hover{
  transform: var(--anchor) scale(1.02);
  box-shadow: 0 10px 28px var(--glow-subtle), 0 0 20px var(--glow-mid);
}

.btn:focus{
  /* remove the visible blue outline on mouse/click focus to match clipboard button */
  outline: none;
}

/* keep an accessible focus indicator for keyboard users */
.btn:focus-visible{
  /* per request: no outline even for focus-visible */
  outline: none;
}

/* provide a brief click/press animation so share/info buttons respond visually */
.btn:active{
  animation: btn-press 220ms ease-out;
}

/* Info button positioned inside .card so its center aligns with the card's bottom edge */
#mode-info-btn{
  position: absolute;
  left: 0;
  top: 100%;
  /* anchor the info button at the card bottom */
  --anchor: translateY(-50%);
  transform: var(--anchor);
  z-index: 30;
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
  /* center text content inside the anchored button across sizes/lines */
  display: inline-flex;
  justify-content: center;
  align-items: center;
  text-align: center;
  white-space: normal;
  box-shadow: 0 8px 18px var(--glow-subtle), 0 0 10px var(--glow-mid);

  /* Use display font variable for Info / Back labels so they visually match the clipboard button */
  font-family: var(--font-display);
  font-weight: 600;
  font-size: clamp(0.78rem, 2.4vw, 0.98rem);
  letter-spacing: 0.06em;
}

.btn[disabled],.btn:disabled,button[disabled],button:disabled{
  cursor:not-allowed;
  pointer-events:none;
  color:rgba(255,255,255,0.85);
}

.btn.success{
  background:var(--color-teal-primary);
  color:white;
  border:none;
  transform-origin:center;
  animation:btn-pulse 360ms ease-out 1;
}

.btn.error{
  background:var(--color-charcoal-dark);
  color:white;
  border-color:rgba(255,255,255,0.06);
}

/* clipboard button grouped with primary button rules */
.btn-clipboard{
  background: var(--color-teal-primary);
  color: var(--color-lime-bright);
  padding:clamp(12px, 3vw, 16px) clamp(20px, 4vw, 28px);
  font-family: var(--font-display);
  font-weight: 600;
  font-size: min(clamp(12px, calc(var(--header-control-effective) * 0.07), 40px), 8.5vw);
  letter-spacing: 0.1em;
  -webkit-text-stroke: min(0.25px, 0.03em) var(--color-lime-bright);
  text-shadow: 0 0 min(8px, 0.8em) var(--color-lime-bright), 0 0 min(12px, 1.2em) var(--color-lime-bright);
  cursor: pointer;
  /* sizing matches `.header-actions .btn` so it adapts the same on narrow screens */
  width: var(--header-control-effective);
  max-width: 100%;
  box-sizing: border-box;
  display: inline-flex;
  justify-content: center;
  align-items: center;
  text-align: center;
  border-radius:var(--radius);
  border:none;
  /* position the clipboard button so it spans the card and its center aligns with the top edge */
  position: absolute;
  left: 0;
  top: 0;
  /* anchor the clipboard button at the card top */
  --anchor: translateY(-50%);
  transform: var(--anchor);
  z-index: 40;
}

.btn-clipboard.success{
  background: var(--color-lime-bright);
  color: var(--color-teal-primary);
  width: var(--header-control-effective);
  max-width: 100%;
  border:none;
  box-shadow: 0 8px 22px var(--lime-10);
  animation: btn-pulse 600ms ease-out 1, btn-glow-up 600ms ease-out 1;
  -webkit-text-stroke: 0;
  text-shadow: none;
}

.btn-clipboard:hover{
  box-shadow: 0 18px 50px var(--lime-16), 0 6px 18px var(--lime-08);
  transform: var(--anchor) scale(1.02);
}

@keyframes btn-pulse{
  0%,100%{transform:var(--anchor) scale(1);box-shadow:0 6px 18px var(--lime-06)}
  50%{transform:var(--anchor) scale(1.06);box-shadow:0 12px 30px var(--lime-14)}
}

@keyframes btn-glow-up{
  0%{box-shadow:0 8px 22px var(--lime-10)}
  30%{box-shadow:0 26px 72px var(--lime-100), 0 0 60px var(--lime-100)}
  60%{box-shadow:0 36px 110px var(--lime-100), 0 0 90px var(--lime-100)}
  100%{box-shadow:0 8px 22px var(--lime-10)}
}

/* Unified glow animation (replaces btn-glow, h1-glow, img-glow) */
@keyframes unified-glow{
  0%,100%{opacity:.9}
  50%{opacity:1}
}
 
@keyframes btn-press{
  0%,100%{transform:var(--anchor) scale(1)}
  50%{transform:var(--anchor) scale(1.02)}
}

@keyframes img-bob{
  0%,100%{transform:translateY(var(--bob-offset,0%)) scale(var(--svg-scale,1))}
  50%{transform:translateY(calc(var(--bob-offset,0%) - 6%)) scale(var(--svg-scale,1))}
}

@keyframes energy-pop{
  0%{
    opacity: 0.9;
    transform: translateY(var(--energy-offset,0%)) scale(0);
    z-index: 100;
  }
  /* Hold visible for longer, use transform-only for most of animation */
  10%{
    opacity: 1;
    transform: translateY(var(--energy-offset,0%)) scale(0.3);
    z-index: 100;
  }
  85%{
    opacity: 0.25;
    transform: translateY(var(--energy-offset,0%)) scale(1);
    z-index: 1;
  }
  100%{
    opacity: 0;
    transform: translateY(var(--energy-offset,0%)) scale(1.05);
  }
}

/* Particles: small glowing blobs that slowly float upward */
.particles{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  pointer-events:none;
  z-index:2;
  overflow:visible;
}
.particles .particle{
  position:absolute;
  bottom:0;
  background: radial-gradient(circle at 40% 30%, var(--lime-95) 0%, var(--lime-55) 30%, var(--glow-mid) 60%, rgba(97,196,151,0) 100%);
  border-radius:50%;
  filter: blur(var(--particles-blur, 6px));
  opacity:0;
  transform: translateY(0) translateX(0) scale(1);
  will-change: transform, opacity, filter;
  mix-blend-mode: screen;
  transition: opacity 160ms linear;
  animation: particle-up var(--dur, 6s) linear infinite;
}

/* Mini particle system inside the header container (always on top) */
.mini-particles{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  pointer-events:none;
  z-index:10002; /* above crown (10001) */
  /* keep overflow visible so particles can escape upward beyond container */
  overflow:visible;
  /* ensure the container itself doesn't contribute to layout overflow */
  contain: layout;
}
.mini-particles .particle-mini{
  position:absolute;
  /* use a solid, fully-opaque color for high visibility during testing */
  background: var(--lime-100);
  border-radius:50%;
  filter: blur(var(--mini-blur, 1px));
  opacity:1; /* start fully opaque; keyframes will keep them visible until near the end */
  transform: translateY(0) translateX(0) scale(1);
  will-change: transform, opacity, filter;
  mix-blend-mode: screen;
  transition: opacity 120ms linear;
  animation: mini-particle-up var(--dur, 1s) linear infinite;
}

/* Click / touch pulse animation (spawn at pointer position) */
:root{
  --click-pulse-color: rgba(213,255,154,0.9);
  --click-pulse-size: 120px; /* default max size of pulse */
  --click-pulse-duration: 520ms;
}
.click-pulse{
  z-index:10003;
  position: absolute;
  pointer-events: none;
  border-radius: 50%;
  background: radial-gradient(circle at 50% 50%, var(--color-teal-primary) 0%, var(--color-teal-primary) 50%, var(--color-lime-bright) 60%, var(--lime-06) 70%, var(--lime-06) 100%);
  transform: translate(-50%, -50%) scale(0.2);
  opacity: 0;
  will-change: transform, opacity;
  /*mix-blend-mode: screen;*/
  animation: click-pulse-grow var(--click-pulse-duration, 520ms) ease-out forwards;
}

@keyframes click-pulse-grow{
  0%{ opacity: 0; transform: translate(-50%, -50%) scale(0.2); }
  30%{ opacity: 0.1; transform: translate(-50%, -50%) scale(0.9); }
  100%{ opacity: 0; transform: translate(-50%, -50%) scale(1.4); }
}

/* Inline SVG star wrapper (uses provided mighty_click.svg content). */
.click-star{
  z-index:10003;
  position: fixed;
  pointer-events: none;
  transform: translate(-50%, -50%) scale(0.22);
  opacity: 0;
  will-change: transform, opacity;
  animation: click-star-grow var(--click-pulse-duration, 520ms) ease-out forwards;
  display: inline-block;
  /*mix-blend-mode: screen;*/
  filter: drop-shadow(0 0 20px var(--color-lime-bright));
}
.click-star svg{ display:block; width:100%; height:100%; }
@keyframes click-star-grow{
  0%{ opacity: 0; transform: translate(-50%, -50%) rotate(var(--rotation, 0deg)) scale(0.22); }
  25%{ opacity: 0.5; transform: translate(-50%, -50%) rotate(var(--rotation, 0deg)) scale(0.4); }
  50%{ opacity: 0.1; transform: translate(-50%, -50%) rotate(var(--rotation, 0deg)) scale(0.88); }
  100%{ opacity: 0; transform: translate(-50%, -50%) rotate(var(--rotation, 0deg)) scale(1.3); }
}

/* Click burst particles (short-lived radial burst atop the pulse) */
:root{
  --click-burst-count: 12;
  --click-burst-size-min: 4px;
  --click-burst-size-max: 10px;
  --click-burst-radius-min: 24px;
  --click-burst-radius-max: 96px;
  --click-burst-duration: 520ms;
}
.click-burst-particle{
  z-index:10004;
  position: fixed;
  pointer-events: none;
  border-radius: 50%;
  background: radial-gradient(circle at 40% 30%, var(--lime-95) 0%, var(--lime-55) 30%, rgba(97,196,151,0) 80%);
  opacity: 1;
  will-change: transform, opacity;
  mix-blend-mode: screen;
  animation: burst-fly var(--click-burst-duration, 520ms) cubic-bezier(.2,.8,.2,1) forwards;
}

@keyframes burst-fly{
  0%{ opacity: 1; transform: translate3d(0,0,0) scale(0); }
  /*50%{ opacity: 1; transform: translate3d(var(--tx, 0px), var(--ty, 0px), 0) scale(0.6); }*/
  100%{ opacity: 0; transform: translate3d(var(--tx, 0px), var(--ty, 0px), 0) scale(1); }
}

@keyframes mini-particle-up{
  0%{ opacity: 0; transform: translateY(0) translateX(0) scale(0); }
  5%{ opacity: 1; transform: translateY(0) translateX(0) scale(1); }
  50%{ opacity: 1; transform: translateY(-2750) translateX(0) scale(2); }
  /* remain fully opaque for the majority of the animation for testing visibility */
  /*95%{ opacity: 1; transform: translateY(-2500%) translateX(0px) scale(0.35); }*/
  100%{ opacity: 0; transform: translateY(-3000%) translateX(0px) scale(0.3); }
}

@keyframes particle-up{
  0%{ opacity: 0; transform: translateY(0) translateX(0) scale(1); }
  8%{ opacity: 1; }
  /* extend the global particles' travel so they float further up the viewport */
  100%{ opacity: 0; transform: translateY(calc(-1 * var(--particles-travel-vh, 320vh))) translateX(var(--drift, 0px)) scale(0.6); }
}

.header-actions, .card {
  min-width: 0;
  max-width: 100%;
}
/* small-screen media queries removed — layout relies on clamp() and tokens */
/* Ensure anchored buttons keep their centering translate while hovered/active */
#mode-info-btn:hover, .btn-clipboard:hover{
  transform: var(--anchor) scale(1.02);
  box-shadow: 0 10px 28px var(--glow-subtle), 0 0 20px var(--glow-mid);
}

/* Use shared press animation which respects the --anchor variable */
#mode-info-btn:active, .btn-clipboard:active{
  animation: btn-press 220ms ease-out;
}

/* Language toggle button */
#lang-toggle{
  --anchor: translateX(-50%);
  position: fixed;
  top: clamp(12px, 3vw, 20px);
  left: 50%;
  transform: var(--anchor);
  background: rgba(var(--teal), 1);
  color: var(--color-lime-bright);
  border: none;
  border-radius: 999px;
  padding: clamp(6px, 1.5vw, 10px) clamp(12px, 3vw, 18px);
  font-family: var(--font-display);
  font-weight: 600;
  font-size: clamp(0.75rem, 2vw, 0.9rem);
  letter-spacing: 0.05em;
  cursor: pointer;
  z-index: 50;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
}

#lang-toggle:hover{
  transform: var(--anchor) scale(1.02);
  box-shadow: 0 6px 16px rgba(0,0,0,0.2), 0 0 12px var(--glow-mid);
}

#lang-toggle:active{
  animation: btn-press 220ms ease-out;
}
</style>
</head>
<body>
  <button id="lang-toggle" aria-label="Switch language">DE</button>
  <div class="grid-background" aria-hidden="true"></div>
  <div class="bottom-pulse" aria-hidden="true"></div>
  <div class="particles" aria-hidden="true"></div>

<header>
  <div class="header-svg-container">
    <img src="./mighty_crown_go.svg" alt="Pokémark" class="header-crown" />
    <div class="energy-particles" aria-hidden="true"></div>
    <div class="mini-particles" aria-hidden="true"></div>
  </div>
  <!--<h1>MÄCHTIGE POKÉMON</h1>-->
  <div class="header-actions">
    <div class="card">
      <button class="btn-clipboard">MÄCHTIGE POKÉMON</button>
      <textarea id="output" readonly></textarea>
      <button id="mode-info-btn" class="btn">INFO</button>
    </div>
  </div>
</header>

<script>
// ===== LANGUAGE SYSTEM =====
const TRANSLATIONS = {
  de: {
    title: 'MÄCHTIGE POKÉMON',
    infoBtn: 'INFO',
    backBtn: 'ZURÜCK',
    copySuccess: '✓',
    copyError: 'Kopieren fehlgeschlagen',
    infoText: {
      usage: 'VERWENDUNG',
      usageContent: 'Kopiere den Suchstring manuell aus dem Textfeld oder drücke den großen Knopf darüber, um ihn in deine Zwischenablage zu speichern. Füge den Suchstring dann in die Pokémon GO Suchleiste ein, um alle mächtigen Pokémon in deinem Besitz zu finden.',
      limitations: 'GRUNDLAGE',
      limitationsContent: 'Die Suchleiste von Pokémon GO kennt keinen "mächtig" Suchbegriff und erlaubt nur einfache AND‑Verknüpfungen (&) und OR-Logik (,), unterstützt weder Klammern noch verschachtelte Bedingungen. Um also alle mächtigen Pokémon in einer Aufbewahrung zu finden, muss jede Kombination aus Pokémon, Form und Fangalter einzeln aufgeführt werden.',
      details: 'DETAILS',
      dnf: 'Disjunktive Normalform',
      dnfContent: 'Jede gültige Kombination wird einzeln gelistet.',
      autoAge: 'Automatischer Altersfilter',
      autoAgeContent: 'Die Zeiträume werden dynamisch berechnet.',
      eventIntel: 'EVENT INTEL',
      event2024: 'Naturzone 23.–24.11.2024',
      event2025: 'Naturzone 15.–16.11.2025',
      pokemon: {
        '003': 'Bisaflor',
        '018': 'Tauboss',
        '038': 'Alola-Vulnona',
        '040': 'Knuddeluff',
        '062': 'Quappo',
        '076': 'Geowaz',
        '078': 'Galar-Galoppa',
        '110': 'Galar-Smogmog',
        '130': 'Garados',
        '149': 'Dragoran',
        '160': 'Impergator',
        '210': 'Granbull',
        '229': 'Hundemon',
        '248': 'Despotar',
        '282': 'Guardevoir',
        '303': 'Flunkifer',
        '359': 'Absol',
        '405': 'Luxtra',
        '430': 'Kramshef',
        '445': 'Knakrack',
        '452': 'Toxiquak',
        '461': 'Snibunna',
        '466': 'Elevoltek',
        '473': 'Mamutel',
        '480': 'Selfe',
        '481': 'Vesprit',
        '482': 'Tobutz',
        '545': 'Cerapendra',
        '596': 'Voltula',
        '604': 'Zapplarang',
        '623': 'Golurk',
        '697': 'Monargoras',
        '748': 'Aggrostella',
        '858': 'Silembrim',
        '862': 'Barrikadax',
        '908': 'Maskagato'
      }
    }
  },
  en: {
    title: 'MIGHTY POKÉMON',
    infoBtn: 'INFO',
    backBtn: 'BACK',
    copySuccess: '✓',
    copyError: 'Copy failed',
    infoText: {
      usage: 'USAGE',
      usageContent: 'Copy the search string from the text field manually or press the large button above to save it to your clipboard. Then paste the search string into the Pokémon GO search bar to find all mighty Pokémon in your collection.',
      limitations: 'FOUNDATION',
      limitationsContent: 'The Pokémon GO search bar does not have a ‘mighty’ search keyword and only supports simple AND operators (&) and OR logic (,), without parentheses or nested conditions. Therefore, to find all mighty Pokémon in storage, every combination of Pokémon, form, and catch age has to be listed individually.',
      details: 'DETAILS',
      dnf: 'Disjunctive Normal Form',
      dnfContent: 'Each valid combination is listed individually.',
      autoAge: 'Automatic Age Filter',
      autoAgeContent: 'Time periods are calculated dynamically.',
      eventIntel: 'EVENT INTEL',
      event2024: 'Wild Area Nov 23–24, 2024',
      event2025: 'Wild Area Nov 15–16, 2025',
      pokemon: {
        '003': 'Venusaur',
        '018': 'Pidgeot',
        '038': 'Alolan Ninetales',
        '040': 'Wigglytuff',
        '062': 'Poliwrath',
        '076': 'Golem',
        '078': 'Galarian Rapidash',
        '110': 'Galarian Weezing',
        '130': 'Gyarados',
        '149': 'Dragonite',
        '160': 'Feraligatr',
        '210': 'Granbull',
        '229': 'Houndoom',
        '248': 'Tyranitar',
        '282': 'Gardevoir',
        '303': 'Mawile',
        '359': 'Absol',
        '405': 'Luxray',
        '430': 'Honchkrow',
        '445': 'Garchomp',
        '452': 'Toxicroak',
        '461': 'Weavile',
        '466': 'Electivire',
        '473': 'Mamoswine',
        '480': 'Uxie',
        '481': 'Mesprit',
        '482': 'Azelf',
        '545': 'Scolipede',
        '596': 'Galvantula',
        '604': 'Eelektross',
        '623': 'Golurk',
        '697': 'Tyrantrum',
        '748': 'Toxapex',
        '858': 'Hatterene',
        '862': 'Obstagoon',
        '908': 'Meowscarada'
      }
    }
  }
};

// Language management
let currentLang = 'de';

function detectLanguage() {
  const stored = localStorage.getItem('pokemon-lang');
  if (stored && (stored === 'de' || stored === 'en')) return stored;
  
  const browserLang = navigator.language || navigator.userLanguage;
  return browserLang.startsWith('de') ? 'de' : 'en';
}

function setLanguage(lang) {
  currentLang = lang;
  localStorage.setItem('pokemon-lang', lang);
  updateUILanguage();
  // Regenerate search string with correct age keyword
  renderPreview();
}

function updateUILanguage() {
  const t = TRANSLATIONS[currentLang];
  
  // Update clipboard button
  const clipboardBtn = document.querySelector('.btn-clipboard');
  if (clipboardBtn && clipboardBtn._origText !== '✓') {
    clipboardBtn.innerText = t.title;
    clipboardBtn._origText = t.title;
  }
  
  // Update info button if not showing back
  if (infoBtn && infoBtn.getAttribute('data-info-open') !== 'true') {
    infoBtn.innerText = t.infoBtn;
  }
  
  // Update language toggle button
  const langToggle = document.getElementById('lang-toggle');
  if (langToggle) {
    langToggle.innerText = currentLang === 'de' ? 'EN' : 'DE';
    langToggle.setAttribute('aria-label', currentLang === 'de' ? 'Switch to English' : 'Zu Deutsch wechseln');
  }
  
  // Re-render if info is open
  if (infoBtn && infoBtn.getAttribute('data-info-open') === 'true') {
    output.value = getInfoText();
    infoBtn.innerText = t.backBtn;
  }
}

// Initialize language on load
currentLang = detectLanguage();

// Pokemon groups
const G1='018,076,130,405,545,596,697,748,003,062,149,160,466,473,604,691';
const G2='40,248,303,359,623,858,862,908,210,229,282,430,445,452,461,480-482';
const FORMS=['110,38,78','110,38,galar','110,alola,78','110,alola,galar','galar,38,78','galar,38','galar,alola,78','galar,alola'];

function generateTemplate(r24,r25){
  const base=FORMS.map(f=>`${G1},${G2},${f}`).join('&');
  const with24=FORMS.map(f=>`${r24},${G2},${f}`).join('&');
  return `${base}&${G1},${r25}&${with24}&${r24},${r25}`;
}

const EVENT24_START = new Date(Date.UTC(2024, 10, 23, 0, 0, 0));
const EVENT24_END   = new Date(Date.UTC(2024, 10, 24, 23, 59, 59));

const EVENT25_START = new Date(Date.UTC(2025, 10, 15, 0, 0, 0));
const EVENT25_END   = new Date(Date.UTC(2025, 10, 16, 23, 59, 59));

const output = document.getElementById('output');
const infoBtn = document.getElementById('mode-info-btn');

// Audio factory - creates restartable audio instances for UI feedback
function createAudio(src, vol = 0.2){
  const a = new Audio(src);
  a.preload = 'auto';
  a.volume = vol;
  return {
    play(){
      try{ a.pause(); a.currentTime = 0; a.play().catch(()=>{}); }catch(e){}
    }
  };
}

// Global audio volume multiplier (0.0 to 1.0)
// Set lower if source files are mastered too loud
const AUDIO_MASTER_VOLUME = 1; // Adjust this value for overall volume control

const _copyNav = createAudio('./copy_nav.opus', 1.0 * AUDIO_MASTER_VOLUME);
const _infoNav = createAudio('./info_nav.opus', 1.0 * AUDIO_MASTER_VOLUME);
const _langNav = createAudio('./lang_nav.opus', 1.0 * AUDIO_MASTER_VOLUME);

function playCopyNavSound(){ _copyNav.play(); }
function playInfoNavSound(){ _infoNav.play(); }
function playLangNavSound(){ _langNav.play(); }

// CSS variable utility - read numeric/string values with fallbacks
const CSS = {
  _root: () => getComputedStyle(document.documentElement),
  num: (name, fallback = 0) => {
    const v = CSS._root().getPropertyValue(name);
    if(!v) return fallback;
    const n = parseFloat(v);
    return Number.isFinite(n) ? n : fallback;
  },
  str: (name, fallback = '') => CSS._root().getPropertyValue(name) || fallback,
  getConfig: (prefix, keys) => {
    const config = {};
    for(const key in keys) {
      config[key] = CSS.num(`${prefix}-${key}`, keys[key]);
    }
    return config;
  }
};

// Base particle system with shared init/spawn logic
class ParticleSystem {
  constructor(selector, configPrefix, className, defaults) {
    this.selector = selector;
    this.configPrefix = configPrefix;
    this.className = className;
    this.defaults = defaults;
    this.container = null;
  }

  init(count) {
    try {
      this.container = document.querySelector(this.selector);
      if(!this.container) return;
      this.container.innerHTML = '';
      
      const cfg = CSS.getConfig(this.configPrefix, this.defaults);
      if(count) cfg.count = count;

      for(let i = 0; i < cfg.count; i++) {
        this.spawnParticle(cfg);
      }
    } catch(e) { /* ignore */ }
  }

  spawnParticle(cfg) {
    // Override in subclass for custom spawn logic
  }

  static random(min, max) {
    return min + Math.random() * (max - min);
  }
}

// Global floating particles
class GlobalParticles extends ParticleSystem {
  constructor() {
    super('.particles', '--particles', 'particle', {
      count: 12,
      'dur-min': 6,
      'dur-max': 14,
      'size-min': 8,
      'size-max': 30,
      'drift-max': 120,
      'delay-range': 10
    });
  }

  spawnParticle(cfg) {
    const p = document.createElement('div');
    p.className = this.className;
    const left = Math.round(Math.random() * 100);
    const bottom = Math.random() * 10;
    const size = Math.round(ParticleSystem.random(cfg['size-min'], cfg['size-max']));
    const dur = ParticleSystem.random(cfg['dur-min'], cfg['dur-max']);
    const delay = -Math.random() * cfg['delay-range'];
    const drift = (Math.random() * (cfg['drift-max'] * 2) - cfg['drift-max']) + 'px';

    p.style.left = left + '%';
    p.style.bottom = bottom + '%';
    p.style.width = size + 'px';
    p.style.height = size + 'px';
    p.style.setProperty('--dur', dur + 's');
    p.style.setProperty('--drift', drift);
    p.style.setProperty('animation-delay', delay + 's');
    this.container.appendChild(p);
  }
}

// Mini header particles (with repositioning logic)
class MiniParticles extends ParticleSystem {
  constructor() {
    super('.header-svg-container .mini-particles, .mini-particles', '--mini', 'particle-mini', {
      count: 10,
      dur: 0.28,
      'size-min': 4,
      'size-max': 12,
      'horizontal-spread-mult': 0.5,
      'vertical-spread-mult': 0.35,
      'jitter-x': 30,
      'jitter-y': 24,
      'spawn-down-ratio': 0.06,
      'spawn-nudge-ratio': 0.06
    });
  }

  spawnParticle(cfg) {
    const p = document.createElement('div');
    p.className = this.className;
    p.style.setProperty('--dur', cfg.dur + 's');
    p.style.setProperty('--drift', '0px');

    const reposition = () => {
      try {
        const r = this.container.getBoundingClientRect();
        if(!r || r.width <= 0) return;

        const crownEl = document.querySelector('.header-crown');
        const energyEl = document.querySelector('.header-energy');
        const spawnDownRatio = cfg['spawn-down-ratio'];
        const spawnNudgePx = r.height * cfg['spawn-nudge-ratio'];

        let baseX = r.width * 0.5;
        let baseY = r.height * 0.45 + r.height * spawnDownRatio + spawnNudgePx;

        if(crownEl) {
          const cRect = crownEl.getBoundingClientRect();
          baseX = (cRect.left + cRect.width * 0.5) - r.left;
          baseY = (cRect.top + cRect.height - r.top) + r.height * (spawnDownRatio * 0.5) + (r.height * 0.06);
        } else if(energyEl) {
          const eRect = energyEl.getBoundingClientRect();
          baseX = (eRect.left + eRect.width * 0.5) - r.left;
          baseY = (eRect.top + eRect.height - r.top) + r.height * (spawnDownRatio * 0.5) + (r.height * 0.06);
        }

        const hSpread = Math.max(20, r.width * cfg['horizontal-spread-mult']);
        const vSpread = Math.max(16, r.height * cfg['vertical-spread-mult']);
        const jitterX = (Math.random() * (cfg['jitter-x'] * 2)) - cfg['jitter-x'];
        const jitterY = (Math.random() * (cfg['jitter-y'] * 2)) - cfg['jitter-y'];
        const xPx = baseX + (Math.random() - 0.5) * hSpread + jitterX;
        const yPx = baseY + (Math.random() - 0.5) * vSpread + jitterY;
        const xPct = r.width > 0 ? (xPx / r.width) * 100 : 50;
        const yPct = r.height > 0 ? (yPx / r.height) * 100 : 30;
        const natural = Math.round(r.width * 0.02);
        const size = Math.max(cfg['size-min'], Math.min(cfg['size-max'], natural));

        p.style.left = Math.min(100, Math.max(0, xPct)).toFixed(4) + '%';
        p.style.top = Math.min(100, Math.max(0, yPct)).toFixed(4) + '%';
        p.style.width = size + 'px';
        p.style.height = size + 'px';
        p.style.setProperty('animation-delay', ((Math.random() * 0.6) - 0.3) + 's');
      } catch(e) { /* ignore */ }
    };

    reposition();
    p.addEventListener('animationiteration', reposition);
    this.container.appendChild(p);
  }
}

// Energy particle system - optimized for mobile performance
class EnergyParticles {
  constructor() {
    this.container = document.querySelector('.energy-particles');
    this.svgUrl = './mighty_energy_go.svg';
    this.particleCount = 4; // Quarter stagger = 4 particles
    this.animationDuration = 4000; // 4s
  }

  async init() {
    if(!this.container) return;
    
    // Create particles with quarter-cycle stagger (1s each)
    const delays = [0, 1000, 2000, 3000]; // 0s, 1s, 2s, 3s
    
    for(let i = 0; i < this.particleCount; i++) {
      const particle = document.createElement('img');
      particle.src = this.svgUrl;
      particle.className = 'energy-particle';
      particle.alt = '';
      particle.style.animationDelay = `-${delays[i]}ms`;
      this.container.appendChild(particle);
    }
  }
}

const energyParticles = new EnergyParticles();

// Singleton instances
const globalParticles = new GlobalParticles();
const miniParticles = new MiniParticles();

// Legacy function wrappers for backward compatibility
function initParticles(count = 12){
  globalParticles.init(count);
}

function initMiniParticles(count = 10){
  miniParticles.init(count);
}

// NOTE: no global busy flag — button animations are reset on each click so
// rapid clicks are allowed while the visual success state is kept until
// the last timeout completes.

/* Info text previously shown in the popover — now generated so it can include live ranges */
function getInfoText(){
  const { range24, range25 } = buildRanges();
  const t = TRANSLATIONS[currentLang].infoText;
  const p = t.pokemon;
  
  return `${t.usage}

${t.usageContent}


${t.limitations}

${t.limitationsContent}


${t.details}

${t.dnf}
${t.dnfContent}

${t.autoAge}
${t.autoAgeContent}


${t.eventIntel}

${t.event2024}
` + range24 + `

#003 ${p['003']}
#018 ${p['018']}
#062 ${p['062']}
#076 ${p['076']}
#130 ${p['130']}
#149 ${p['149']}
#160 ${p['160']}
#405 ${p['405']}
#466 ${p['466']}
#473 ${p['473']}
#545 ${p['545']}
#596 ${p['596']}
#604 ${p['604']}
#697 ${p['697']}
#748 ${p['748']}

${t.event2025}
` + range25 + `

#040 ${p['040']}
#078 ${p['078']}
#110 ${p['110']}
#038 ${p['038']}
#248 ${p['248']}
#303 ${p['303']}
#359 ${p['359']}
#623 ${p['623']}
#858 ${p['858']}
#862 ${p['862']}
#908 ${p['908']}
#210 ${p['210']}
#229 ${p['229']}
#282 ${p['282']}
#430 ${p['430']}
#445 ${p['445']}
#452 ${p['452']}
#461 ${p['461']}
#480 ${p['480']}
#481 ${p['481']}
#482 ${p['482']}
`;
}

function daysSince(date){
  const msPerDay = 1000*60*60*24;
  return Math.floor((Date.now() - date.getTime())/msPerDay);
}

function buildRanges(){
  const ageKeyword = currentLang === 'de' ? 'alter' : 'age';
  const min24 = daysSince(EVENT24_END);
  const max24 = daysSince(EVENT24_START);
  const r24 = `${ageKeyword}${min24}-${max24}`;
  const min25 = daysSince(EVENT25_END);
  const max25 = daysSince(EVENT25_START);
  const r25 = `${ageKeyword}${min25}-${max25}`;
  return { range24: r24, range25: r25 };
}

function generateFinalString(){
  const { range24, range25 } = buildRanges();
  return generateTemplate(range24,range25)
    .split('&').map(g => g.trim().replace(/,+/g, ',').replace(/^,|,$/g, ''))
    .filter(g => g.length > 0).join('&').replace(/\s+/g, ' ');
}

let cachedString = '';
let _prevCachedString;
let searchString = ''; // Always holds the actual search string for clipboard

function renderPreview(){
  if(!output) return;
  searchString = generateFinalString();
  cachedString = searchString;
  output.value = cachedString;
  // if info was shown in the textarea, close that state and update the Info button label
  const t = TRANSLATIONS[currentLang];
  try{
    if(infoBtn && infoBtn.getAttribute('data-info-open') === 'true'){
      infoBtn.setAttribute('data-info-open','false');
      infoBtn.innerText = t.infoBtn;
    }
  }catch(e){}
  requestAnimationFrame(() => { if(output) output.scrollTop = 0; });
  // After rendering new content recompute whether the body should be centered
  requestAnimationFrame(ResizeManager.updateBodyCentered);
}

let timer;

function scheduleMidnightUpdate(){
  if(timer) clearTimeout(timer);
  const now = new Date();
  const next = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0, 0);
  const ms = next.getTime() - now.getTime();
  timer = setTimeout(()=>{
    renderPreview();
    scheduleMidnightUpdate();
  }, ms + 1000);
}

// Phase 8: Unified resize management
const ResizeManager = {
  updateBodyCentered() {
    try {
      const docHeight = Math.max(document.documentElement.scrollHeight, document.body.scrollHeight);
      const viewH = window.innerHeight || document.documentElement.clientHeight;
      document.body.classList.toggle('centered', docHeight <= viewH + 1);
    } catch(e) {}
  },
  
  updateParticlesAndGlow() {
    initParticles(12);
    initMiniParticles(10);
    updateGlowPosition();
  }
};

window.addEventListener('resize', ResizeManager.updateBodyCentered);
window.addEventListener('orientationchange', ResizeManager.updateBodyCentered);
document.addEventListener('visibilitychange', () => !document.hidden && ResizeManager.updateBodyCentered());

function toggleModeInfo(){
  if(!infoBtn || !output) return;
  const isOpen = infoBtn.getAttribute('data-info-open') === 'true';
  const t = TRANSLATIONS[currentLang];

  if(!isOpen){
    _prevCachedString = cachedString;
    const info = getInfoText();
    cachedString = info;
    output.value = info;
    requestAnimationFrame(()=>{ if(output) output.scrollTop = 0; });
    infoBtn.setAttribute('data-info-open', 'true');
    infoBtn.innerText = t.backBtn;
    requestAnimationFrame(ResizeManager.updateBodyCentered);
  } else {
    infoBtn.setAttribute('data-info-open', 'false');
    infoBtn.innerText = t.infoBtn;
    if(_prevCachedString){
      cachedString = _prevCachedString;
      _prevCachedString = undefined;
      output.value = cachedString;
      requestAnimationFrame(()=>{ if(output) output.scrollTop = 0; });
      requestAnimationFrame(ResizeManager.updateBodyCentered);
    } else {
      renderPreview();
    }
  }
}

function _setButtonState(btn, text, state){
  if(!btn) return;
  if(btn._timeout) clearTimeout(btn._timeout);
  if(!btn._origText) btn._origText = btn.innerText;
  // we don't change or rely on `disabled` here — allow repeated clicks.

  // preserve the button's current layout size so short temporary labels (like "✓")
  // don't cause the button to shrink. Store existing inline minHeight to restore later.
  try{
    if(!btn._savedMinHeight){
      btn._savedMinHeight = btn.style.minHeight || '';
      const rect = btn.getBoundingClientRect();
      if(rect && rect.height){
        btn.style.minHeight = rect.height + 'px';
      }
    }
  }catch(e){}

  // Update label and restart the visual animation for the requested state.
  btn.innerText = text;
  // remove any previous state classes first
  btn.classList.remove('success','error');
  if(state){
    // force-animation-restart: clear inline animation, force reflow, then add class
    btn.style.animation = 'none';
    // read a layout property to flush style changes
    void btn.offsetWidth;
    btn.classList.add(state);
    // allow future CSS animations to run normally
    btn.style.animation = '';
  }
  
  const ms = btn.classList.contains('btn-clipboard') ? 1000 : 360;
  btn._timeout = setTimeout(()=>{
    // restore original text and any preserved minHeight
    btn.innerText = btn._origText;
    btn.classList.remove('success','error');
    try{
      if(btn._savedMinHeight !== undefined){
        btn.style.minHeight = btn._savedMinHeight || '';
        delete btn._savedMinHeight;
      }
    }catch(e){}
    delete btn._timeout;
  }, ms);
}

function copyAndNotify(btn){
  const button = btn || document.querySelector('.btn-clipboard');
  const t = TRANSLATIONS[currentLang];
  navigator.clipboard.writeText(searchString || generateFinalString()).then(()=>{
    renderPreview();
    _setButtonState(button, t.copySuccess, 'success');
  }, ()=>{
    _setButtonState(button, t.copyError, 'error');
  });
}

// Attach event listeners instead of using inline onclick attributes. Listeners
// check `uiBusy` and will ignore clicks while busy.
const _attachUIListeners = ()=>{
  const clipboardEl = document.querySelector('.btn-clipboard');
  if(clipboardEl){
    clipboardEl._origText = clipboardEl.innerText;
    clipboardEl.addEventListener('click', (e)=>{
      playCopyNavSound();
      copyAndNotify(clipboardEl);
    });
  }
  if(infoBtn){
    infoBtn.addEventListener('click', (e)=>{
      // Always play the info navigation sound for both opening and closing
      playInfoNavSound();
      toggleModeInfo();
    });
  }
  
  // Language toggle button
  const langToggle = document.getElementById('lang-toggle');
  if(langToggle){
    langToggle.addEventListener('click', ()=>{
      // play language switch SFX, trigger a short background glitch, then toggle language
      try{ playLangNavSound(); }catch(e){}
      const bg = document.querySelector('.grid-background');
      if(bg){
        // restart class to retrigger animation
        bg.classList.remove('glitch');
        void bg.offsetWidth;
        bg.classList.add('glitch');
        // remove the class after the effect finishes
        setTimeout(()=>{ try{ bg.classList.remove('glitch'); }catch(e){} }, 600);
      }
      const newLang = currentLang === 'de' ? 'en' : 'de';
      setLanguage(newLang);
    });
  }
};

_attachUIListeners();
// Initialize UI language after listeners are attached
updateUILanguage();


// Update glow position to follow crown location
function updateGlowPosition(){
  try{
    const crown = document.querySelector('.header-crown');
    if(!crown) return;
    const rect = crown.getBoundingClientRect();
    const x = ((rect.left + rect.width/2) / window.innerWidth) * 100;
    const y = ((rect.top + rect.height * 0.7) / window.innerHeight) * 100;
    document.documentElement.style.setProperty('--glow-x', x + '%');
    document.documentElement.style.setProperty('--glow-y', y + '%');
  }catch(e){}
}

renderPreview();
scheduleMidnightUpdate();
// Initialize energy particles first for optimal visual layering
energyParticles.init();
// initialize particles after rendering so header sizes are known
initParticles(12);
// initialize mini particles (inside header) after main particles
initMiniParticles(10);
// Position the glow initially (defer to next frame to ensure layout is complete)
requestAnimationFrame(()=> requestAnimationFrame(updateGlowPosition));
// Update glow when crown image loads
const crownImg = document.querySelector('.header-crown');
if(crownImg){
  if(crownImg.complete){
    requestAnimationFrame(updateGlowPosition);
  } else {
    crownImg.addEventListener('load', ()=> requestAnimationFrame(updateGlowPosition));
  }
}
// Phase 8: Debounced resize handlers using ResizeManager
let _resizeTimer;
const debounceResize = (fn, delay) => () => {
  clearTimeout(_resizeTimer);
  _resizeTimer = setTimeout(fn, delay);
};

window.addEventListener('resize', debounceResize(ResizeManager.updateParticlesAndGlow, 200));

if(window.visualViewport) {
  window.visualViewport.addEventListener('resize', debounceResize(ResizeManager.updateParticlesAndGlow, 150));
}

document.addEventListener('visibilitychange', ()=>{ !document.hidden && (renderPreview(), scheduleMidnightUpdate()); });

// Prevent pinch-to-zoom on mobile browsers
document.addEventListener('gesturestart', function(e) {
  e.preventDefault();
}, { passive: false });

document.addEventListener('touchmove', function(e) {
  if (e.touches && e.touches.length > 1) {
    e.preventDefault();
  }
}, { passive: false });

// Ensure energy layers that just started their pulse are visually on top.
// Listen for animationstart/animationiteration for the `energy-pop` animation
// and temporarily bump the element's inline z-index, then restore it.
(function(){
  function parseFirstDuration(str){
    if(!str) return 4;
    const first = (str.split(',')[0]||'4s').trim();
    // allow values like "1.5s" or "200ms"
    if(first.endsWith('ms')) return parseFloat(first) / 1000 || 4;
    return parseFloat(first) || 4;
  }

  function makeBumper(el){
    const cs = getComputedStyle(el);
    const dur = parseFirstDuration(cs.animationDuration);
    // store original z (computed) so we can restore; if 'auto' use empty string
    const baseZ = cs.zIndex === 'auto' ? '' : cs.zIndex;
    el.dataset._baseZ = baseZ;
    const resetDelay = Math.max(200, dur * 1000 * 0.5);
    const bump = ()=>{
      if(el._zResetTimeout) clearTimeout(el._zResetTimeout);
      el.style.zIndex = 10000;
      el._zResetTimeout = setTimeout(()=>{
        if(el.dataset._baseZ === '') el.style.zIndex = '';
        else el.style.zIndex = el.dataset._baseZ;
        delete el._zResetTimeout;
      }, resetDelay);
    };
    el.addEventListener('animationstart', (ev)=>{ if(ev.animationName === 'energy-pop') bump(); });
    el.addEventListener('animationiteration', (ev)=>{ if(ev.animationName === 'energy-pop') bump(); });
  }

  // run on DOMContentLoaded to ensure elements exist
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('.header-energy').forEach(makeBumper);
    });
  } else {
    document.querySelectorAll('.header-energy').forEach(makeBumper);
  }
})();

// Click effects system (Phase 6 refactor: unified pulse + burst)
(function(){
  if(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

  class ClickEffects {
    constructor() {
      this._cachedClickSVG = null;
      this._rotation = 0;
      this._loadSVG();
    }

    async _loadSVG() {
      if(this._cachedClickSVG) return this._cachedClickSVG;
      try {
        const res = await fetch('./mighty_click.svg');
        this._cachedClickSVG = await res.text();
      } catch(e) {
        this._cachedClickSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 117.8 117.8"><defs><style>.cls-1{fill:#d5ff9a}.cls-2{fill:#61c497}</style></defs><g><path class="cls-2" d="M114.12,58.9c0-2.19.79-4.89,1.63-7.74,1.53-5.19,3.26-11.07.89-16.66-2.38-5.62-7.74-8.37-12.47-10.79-2.5-1.28-4.86-2.49-6.22-3.86-1.37-1.37-2.58-3.73-3.86-6.22-2.43-4.73-5.18-10.1-10.79-12.47C81.48.39,79.45,0,77.27,0,73.62,0,70.07,1.04,66.64,2.05c-2.85.84-5.55,1.63-7.74,1.63s-4.89-.79-7.74-1.63C47.73,1.04,44.18,0,40.54,0c-2.18,0-4.21.39-6.03,1.16-5.62,2.38-8.37,7.74-10.79,12.47-1.28,2.5-2.49,4.86-3.86,6.22-1.37,1.37-3.73,2.58-6.22,3.86-4.73,2.43-10.1,5.18-12.47,10.79-2.36,5.59-.63,11.47.89,16.66.84,2.85,1.63,5.55,1.63,7.74s-.79,4.89-1.63,7.74c-1.53,5.19-3.26,11.07-.89,16.66,2.38,5.62,7.74,8.37,12.47,10.79,2.5,1.28,4.86,2.49,6.22,3.86,1.37,1.37,2.58,3.73,3.86,6.22,2.43,4.73,5.18,10.1,10.79,12.47,1.82.77,3.85,1.16,6.03,1.16,3.65,0,7.2-1.04,10.63-2.05,2.85-.84,5.55-1.63,7.74-1.63s4.89.79,7.74,1.63c3.43,1.01,6.98,2.05,10.63,2.05,2.21,0,4.18-.38,6.03-1.16,5.62-2.38,8.37-7.74,10.79-12.47,1.28-2.5,2.49-4.86,3.86-6.22,1.37-1.37,3.73-2.58,6.22-3.86,4.73-2.43,10.1-5.18,12.47-10.79,2.36-5.59.63-11.47-.89-16.66-.84-2.85-1.63-5.55-1.63-7.74Z"/><path class="cls-1" d="M77.27,4c1.54,0,3.04.24,4.47.84,7.02,2.97,8.74,13.21,13.38,17.84,4.63,4.63,14.87,6.36,17.84,13.38,2.97,7.02-2.84,15.76-2.84,22.84s5.81,15.82,2.84,22.84c-2.97,7.02-13.21,8.74-17.84,13.38-4.63,4.63-6.36,14.87-13.38,17.84-1.43.6-2.93.84-4.47.84-6.04,0-12.73-3.69-18.37-3.69s-12.33,3.69-18.36,3.69c-1.54,0-3.04-.24-4.47-.84-7.02-2.97-8.74-13.21-13.38-17.84-4.63-4.63-14.87-6.36-17.84-13.38-2.97-7.02,2.84-15.76,2.84-22.84s-5.81-15.82-2.84-22.84c2.97-7.02,13.21-8.74,17.84-13.38,4.63-4.63,6.36-14.87,13.38-17.84,1.43-.6,2.93-.84,4.47-.84,6.04,0,12.73,3.69,18.36,3.69s12.33-3.69,18.37-3.69M77.27,0C73.62,0,70.07,1.04,66.64,2.05c-2.85.84-5.55,1.63-7.74,1.63s-4.89-.79-7.74-1.63C47.73,1.04,44.18,0,40.54,0c-2.18,0-4.21.39-6.03,1.16-5.62,2.38-8.37,7.74-10.79,12.47-1.28,2.5-2.49,4.86-3.86,6.22-1.37,1.37-3.73,2.58-6.22,3.86-4.73,2.43-10.1,5.18-12.47,10.79-2.36,5.59-.63,11.47.89,16.66.84,2.85,1.63,5.55,1.63,7.74s-.79,4.89-1.63,7.74c-1.53,5.19-3.26,11.07-.89,16.66,2.38,5.62,7.74,8.37,12.47,10.79,2.5,1.28,4.86,2.49,6.22,3.86,1.37,1.37,2.58,3.73,3.86,6.22,2.43,4.73,5.18,10.1,10.79,12.47,1.82.77,3.85,1.16,6.03,1.16,3.65,0,7.2-1.04,10.63-2.05,2.85-.84,5.55-1.63,7.74-1.63s4.89.79,7.74,1.63c3.43,1.01,6.98,2.05,10.63,2.05,2.21,0,4.18-.38,6.03-1.16,5.62-2.38,8.37-7.74,10.79-12.47,1.28-2.5,2.49-4.86,3.86-6.22,1.37-1.37,3.73-2.58,6.22-3.86,4.73-2.43,10.1-5.18,12.47-10.79,2.36-5.59.63-11.47-.89-16.66-.84-2.85-1.63-5.55-1.63-7.74s.79-4.89,1.63-7.74c1.53-5.19,3.26-11.07-.89-16.66-2.38-5.62-7.74-8.37-12.47-10.79-2.5-1.28-4.86-2.49-6.22-3.86-1.37-1.37-2.58-3.73-3.86-6.22-2.43-4.73-5.18-10.1-10.79-12.47C81.48.39,79.45,0,77.27,0h0Z"/></g></svg>`;
      }
      return this._cachedClickSVG;
    }

    async pulse(x, y) {
      try {
        const wrapper = document.createElement('div');
        wrapper.className = 'click-star';
        const maxSize = CSS.num('--click-pulse-size', 120);
        const size = Math.round((maxSize * 0.6) + (Math.random() * maxSize * 0.4));
        wrapper.style.width = size + 'px';
        wrapper.style.height = size + 'px';
        wrapper.innerHTML = await this._loadSVG();
        wrapper.style.left = x + 'px';
        wrapper.style.top = y + 'px';
        this._rotation -= 5;
        wrapper.style.setProperty('--rotation', this._rotation + 'deg');
        document.body.appendChild(wrapper);
        wrapper.addEventListener('animationend', () => wrapper.remove());
        setTimeout(() => wrapper.parentNode && wrapper.remove(), 1200);
      } catch(e) {/* ignore */}
    }

    burst(x, y) {
      try {
        const cfg = CSS.getConfig('--click-burst', {
          count: 12, 'size-min': 4, 'size-max': 10, 'radius-min': 24, 'radius-max': 96
        });
        const dur = CSS.str('--click-burst-duration', '520ms');
        for(let i=0; i<cfg.count; i++) {
          const p = document.createElement('div');
          p.className = 'click-burst-particle';
          const size = Math.round(cfg['size-min'] + Math.random() * (cfg['size-max'] - cfg['size-min']));
          p.style.width = size + 'px';
          p.style.height = size + 'px';
          p.style.left = (x - size/2) + 'px';
          p.style.top = (y - size/2) + 'px';
          const angle = Math.random() * Math.PI * 2;
          const dist = cfg['radius-min'] + Math.random() * (cfg['radius-max'] - cfg['radius-min']);
          p.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
          p.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
          p.style.animation = `burst-fly ${dur} cubic-bezier(.2,.8,.2,1) forwards`;
          document.body.appendChild(p);
          p.addEventListener('animationend', () => p.remove());
          setTimeout(() => p.parentNode && p.remove(), 1200);
        }
      } catch(e) {/* ignore */}
    }

    emit(x, y) {
      this.pulse(x, y);
      this.burst(x, y);
    }
  }

  const clickEffects = new ClickEffects();
  const isInteractive = (el) => !!el.closest('button, a, textarea, input, select, .btn, .btn-clipboard, #mode-info-btn');

  window.addEventListener('pointerdown', (ev) => {
    if(!isInteractive(ev.target)) clickEffects.emit(ev.clientX, ev.clientY);
  }, {passive:true});
})();
</script>

</body>
</html>
