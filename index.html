<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mächtiger Suchstring</title>
  <link rel="icon" href="./mighty_mark_go.svg" type="image/svg+xml" />
  <link rel="shortcut icon" href="./mighty_mark_go.svg" />
<style>
:root{
  --color-bg-dark-teal: #12251d;
  --color-bg-charcoal: #0f1011;
  --color-lime-bright: #d5ff9a;
  --color-teal-primary: #61C497;
  --color-charcoal-dark: #1a1b1c;
  --color-border-subtle: rgba(255,255,255,0.03);
  --color-focus-blue: rgba(78, 144, 254, 0.12);
  --header-control-effective: clamp(min(140px, 95vw), 85vw, 300px);
  --radius: 999px;
  --transition-smooth: 520ms cubic-bezier(.2,0,.2,1);
  --transition-fast: 120ms ease;
}

html{box-sizing:border-box}
*,*::before,*::after{box-sizing:inherit}

html,body{
  height:100%;
  margin:0;
  font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
}

body{
  background:var(--color-bg-dark-teal);
  color:var(--color-teal-primary);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  position:relative;
  z-index:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  min-height:100vh;
  padding:clamp(12px, 3vw, 28px);
  box-sizing:border-box;
}

body::before{
  content: "";
  position:fixed;
  inset:0;
  background-image: url('./young_will.png');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  opacity: 0.15;
  pointer-events: none;
  z-index: 0;
  mix-blend-mode: overlay;
  -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,0.0), rgba(0,0,0,1));
  mask-image: linear-gradient(to bottom, rgba(0,0,0,0.0), rgba(0,0,0,1));
}

body > *{position:relative;z-index:1}

header{
  background: transparent;
  color:var(--color-teal-primary); 
  padding:clamp(8px, 2.5vw, 18px) 0 clamp(4px, 1vw, 6px) 0;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:clamp(6px, 2vw, 10px);
  position:relative;
  width:100%;
  max-width:min(980px, 95vw);
}

header img{
  width: var(--header-control-effective);
  height: auto;
  flex: 0 0 auto;
  max-width: 92vw;
  object-fit: contain;
  border-radius:0;
  /* pulsating lime glow on SVG paths */
  filter: drop-shadow(0 0 20px var(--color-lime-bright));
  animation: img-glow 3s ease-in-out infinite;
}

.header-actions{
  display:flex;
  flex-direction:column;
  gap:clamp(6px, 1.5vw, 8px);
  align-items:center;
  justify-content:center;
  margin-top:clamp(4px, 1vw, 6px);
  position:relative;
  width:100%;
}

.header-actions .btn{
  padding:clamp(8px, 2vw, 10px) clamp(14px, 3vw, 18px);
  border-radius:var(--radius);
  /* match the card width so buttons visually enclose the card */
  width: var(--header-control-effective);
  max-width:100%;
  display:block;
  margin:0 auto;
}

h1{
  margin: clamp(8px, 2vw, 12px) auto 0 auto;
  /* scale the heading with the header control token so it visually spans the image width */
  font-size: clamp(12px, calc(var(--header-control-effective) * 0.09), 40px);
  font-weight:600;
  text-align:center;
  /* allow wrapping on narrow screens so text remains centered */
  white-space: normal;
  /* allow descenders (g, y) to render without being clipped */
  overflow: visible;
  /* match the card width exactly so h1 stays centered at all zoom levels */
  width: var(--header-control-effective);
  max-width: 100%;
  box-sizing: border-box;
  /* no horizontal padding - let text-align:center handle centering within the fixed width */
  padding: 0;
  /* slightly increased line-height and bottom padding to avoid clipping descenders */
  line-height:1.15;
  padding-bottom: clamp(4px, 1vw, 6px);
  /* lime outline + pulsating glow */
  /* primary outline for WebKit browsers (reduced thickness) */
  -webkit-text-stroke: 0.25px var(--color-lime-bright);
  /* text-stroke fallback via multiple tiny shadows for other browsers (thinner) */
  text-shadow: -0.6px -0.6px 0 var(--color-lime-bright), 0.6px -0.6px 0 var(--color-lime-bright), -0.6px 0.6px 0 var(--color-lime-bright), 0.6px 0.6px 0 var(--color-lime-bright), 0 0 20px var(--color-lime-bright);
  animation: h1-glow 3s ease-in-out infinite;
}

header h1:first-of-type{
  /* slightly smaller primary header scale to avoid oversized headings */
  font-size: clamp(16px, calc(var(--header-control-effective) * 0.105), 48px);
  /* add extra breathing room under the primary header */
  margin-bottom: clamp(12px, 3vw, 20px);
}

header h2{
  font-size:clamp(16px, 4.5vw, 36px);
  margin:0 auto;
  font-weight:600;
  color:var(--color-teal-primary);
  text-align:center;
  width:100%;
  max-width:var(--header-control-effective);
  box-sizing:border-box;
  line-height:1.2;
}

.p-muted{
  color:var(--color-teal-primary);
  margin:0 0 clamp(6px, 1.5vw, 8px) 0;
  font-size:clamp(0.85rem, 2vw, 0.95rem);
}

.p-muted.small{
  display:block;
  width:100%;
  max-width:var(--header-control-effective);
  margin:clamp(8px, 2vw, 12px) auto 0;
  text-align:center;
  font-size: clamp(11px, 2.5vw, 14px);
  line-height: 1.4;
  padding:0 clamp(8px, 2vw, 12px);
}

.card{
  background:var(--color-lime-bright);
  /*border-radius:clamp(20px, 4vw, 25px);*/
  padding:clamp(25px, 4vw, 35px) clamp(12px, 3vw, 18px) clamp(25px, 3vw, 18px) clamp(12px, 3vw, 18px);
  margin-bottom:clamp(10px, 2.5vw, 16px);
  /* remove negative overlap so the card sits below the header */
  margin-top: 20px;
  border:none;
  position:relative;
  z-index:1;
  width: 100%;
  width: var(--header-control-effective);
  max-width: 100%;
  margin-left: auto;
  margin-right: auto;
  max-height: 1200px;
  overflow: visible;
  opacity: 1;
  transform: translateY(0);
  transition: max-height var(--transition-smooth), opacity 420ms ease, transform 420ms ease, padding 420ms ease, margin 420ms ease;
  will-change: transform;
}

textarea{
  width:100%;
  min-height:clamp(140px, 30vw, 220px);
  max-height:clamp(50vh, 70vh, 80vh);
  /* symmetric vertical / horizontal padding to avoid visual horizontal shift on narrow screens */
  padding: 0px;
  margin-top: clamp(12px, 3vw, 20px);
  margin-left: clamp(2px, 0vw, 5px);
  border:none;
  background:var(--color-lime-bright);
  color:var(--color-teal-primary);
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
  font-size:clamp(11px, 2vw, 13px);
  resize:none;
  white-space:pre-wrap;
  word-break:break-word;
  overflow:auto;
  overflow-wrap: anywhere;
  /* hide visible scrollbars but keep scrolling functional */
  -ms-overflow-style: none; /* IE/Edge */
  scrollbar-width: none; /* Firefox */
  scrollbar-color: transparent transparent;
}

textarea:focus{
  outline:none;
  box-shadow:none;
}

/* hide webkit scrollbars */
textarea::-webkit-scrollbar{
  width: 0px;
  height: 0px;
  background: transparent;
}

textarea::-webkit-scrollbar-track{
  background: transparent;
}

textarea::-webkit-scrollbar-thumb{
  background: transparent;
  border: none;
  opacity: 0;
}

.card:hover textarea::-webkit-scrollbar-thumb,textarea:focus::-webkit-scrollbar-thumb{
  opacity:1;
  background: var(--color-teal-primary);
}
.card:hover textarea{
  scrollbar-color: var(--color-teal-primary) transparent;
}

.btn{
  background: var(--color-teal-primary);
  color: var(--color-lime-bright);
  padding:clamp(8px, 2vw, 10px) clamp(12px, 2.5vw, 14px);
  border-radius:var(--radius);
  border:none;
  font-weight:600;
  font-size:clamp(0.85rem, 2vw, 1rem);
  cursor:pointer;
  transition:transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), color var(--transition-fast);
  box-shadow:none;
  will-change: transform;
  transform-origin:center;
}

.btn:hover{
  transform:scale(1.02);
  box-shadow:0 10px 28px rgba(0,0,0,0.30);
}

.btn:focus{
  /* remove the visible blue outline on mouse/click focus to match clipboard button */
  outline: none;
}

/* keep an accessible focus indicator for keyboard users */
.btn:focus-visible{
  /* per request: no outline even for focus-visible */
  outline: none;
}

/* provide a brief click/press animation so share/info buttons respond visually */
.btn:active{
  animation: btn-press 220ms ease-out;
  transform-origin: center;
  will-change: transform;
}

/* Info button positioned inside .card so its center aligns with the card's bottom edge */
#mode-info-btn{
  position: absolute;
  left: 0;
  top: 100%;
  transform: translateY(-50%);
  z-index: 30;
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
  /* center text content inside the anchored button across sizes/lines */
  display: inline-flex;
  justify-content: center;
  align-items: center;
  text-align: center;
  white-space: normal;
  box-shadow: 0 8px 18px rgba(0,0,0,0.18);
}

.btn[disabled],.btn:disabled,button[disabled],button:disabled{
  cursor:not-allowed;
  pointer-events:none;
  color:rgba(255,255,255,0.85);
}

.btn.success{
  background:#2b8a3e;
  color:white;
  border:none;
  transform-origin:center;
  animation:btn-pulse 360ms ease-out 1;
}

.btn.error{
  background:#8a2b2b;
  color:white;
  border-color:rgba(255,255,255,0.06);
}

/* clipboard button grouped with primary button rules */
.btn-clipboard{
  background: var(--color-teal-primary);
  color: var(--color-lime-bright);
  padding:clamp(12px, 3vw, 16px) clamp(20px, 4vw, 28px);
  font-weight: 600;
  font-size:clamp(0.95rem, 7.5vw, 1.48rem);
  cursor: pointer;
  /* sizing matches `.header-actions .btn` so it adapts the same on narrow screens */
  width: var(--header-control-effective);
  max-width: 100%;
  box-sizing: border-box;
  display: inline-flex;
  justify-content: center;
  align-items: center;
  text-align: center;
  border-radius:var(--radius);
  border:none;
  /* position the clipboard button so it spans the card and its center aligns with the top edge */
  position: absolute;
  left: 0;
  top: 0;
  transform: translateY(-50%);
  z-index: 40;
}

.btn-clipboard.success{
  background: rgb(213, 255, 154);
  color: var(--color-teal-primary);
  width: var(--header-control-effective);
  max-width: 100%;
  border:none;
  /* use anchored animation so translateY(-50%) is preserved during the pulse */
  animation: anchored-btn-pulse 400ms ease-out 1, btn-glow 400ms ease-out 1;
}

.btn-clipboard:hover{
  box-shadow: 0 18px 50px rgba(213,255,154,0.16), 0 6px 18px rgba(213,255,154,0.08);
  transform: scale(1.02);
}

@keyframes btn-pulse{
  0%{transform:scale(1);box-shadow:0 6px 18px rgba(213, 255, 154,0.06)}
  50%{transform:scale(1.06);box-shadow:0 12px 30px rgba(213, 255, 154,0.14)}
  100%{transform:scale(1);box-shadow:0 6px 18px rgba(213, 255, 154,0.06)}
}

@keyframes anchored-btn-pulse{
  0%{transform:translateY(-50%) scale(1);box-shadow:0 6px 18px rgba(213, 255, 154,0.06)}
  50%{transform:translateY(-50%) scale(1.06);box-shadow:0 12px 30px rgba(213, 255, 154,0.14)}
  100%{transform:translateY(-50%) scale(1);box-shadow:0 6px 18px rgba(213, 255, 154,0.06)}
}

@keyframes btn-glow{
  0%{ box-shadow: 0 8px 22px rgba(213, 255, 154,0.10), 0 0 0 rgba(213, 255, 154,0); }
  30%{ box-shadow: 0 26px 72px rgba(213, 255, 154,1.30), 0 0 60px rgba(213, 255, 154,1.24); }
  60%{ box-shadow: 0 36px 110px rgba(213, 255, 154,5.40), 0 0 90px rgba(213, 255, 154,5.32); }
  100%{ box-shadow: 0 8px 22px rgba(213, 255, 154,0.10), 0 0 0 rgba(213, 255, 154,0); }
}
 
@keyframes btn-press{
  0%{ transform: scale(1); }
  50%{ transform: scale(1.02); }
 100%{ transform: scale(1); }
}

@keyframes anchored-btn-press{
  0%{ transform: translateY(-50%) scale(1); }
  50%{ transform: translateY(-50%) scale(1.02); }
 100%{ transform: translateY(-50%) scale(1); }
}

@keyframes h1-glow{
  0%{ text-shadow: -0.6px -0.6px 0 var(--color-lime-bright), 0.6px -0.6px 0 var(--color-lime-bright), -0.6px 0.6px 0 var(--color-lime-bright), 0.6px 0.6px 0 var(--color-lime-bright), 0 0 20px var(--color-lime-bright), 0 0 30px rgba(213, 255, 154, 0.4); }
  50%{ text-shadow: -0.6px -0.6px 0 var(--color-lime-bright), 0.6px -0.6px 0 var(--color-lime-bright), -0.6px 0.6px 0 var(--color-lime-bright), 0.6px 0.6px 0 var(--color-lime-bright), 0 0 30px var(--color-lime-bright), 0 0 50px rgba(213, 255, 154, 0.8), 0 0 70px rgba(213, 255, 154, 0.6); }
  100%{ text-shadow: -0.6px -0.6px 0 var(--color-lime-bright), 0.6px -0.6px 0 var(--color-lime-bright), -0.6px 0.6px 0 var(--color-lime-bright), 0.6px 0.6px 0 var(--color-lime-bright), 0 0 20px var(--color-lime-bright), 0 0 30px rgba(213, 255, 154, 0.4); }
}

@keyframes img-glow{
  0%{ filter: drop-shadow(0 0 20px var(--color-lime-bright)) drop-shadow(0 0 30px rgba(213, 255, 154, 0.4)); }
  50%{ filter: drop-shadow(0 0 30px var(--color-lime-bright)) drop-shadow(0 0 50px rgba(213, 255, 154, 0.8)) drop-shadow(0 0 70px rgba(213, 255, 154, 0.6)); }
  100%{ filter: drop-shadow(0 0 20px var(--color-lime-bright)) drop-shadow(0 0 30px rgba(213, 255, 154, 0.4)); }
}

.header-actions, .card {
  min-width: 0;
  max-width: 100%;
}
/* small-screen media queries removed — layout relies on clamp() and tokens */
/* Ensure anchored buttons keep their centering translate while hovered/active */
#mode-info-btn:hover, .btn-clipboard:hover{
  transform: translateY(-50%) scale(1.02);
  box-shadow:0 10px 28px rgba(0,0,0,0.30);
}

/* Use anchored press animation for anchored buttons so translate is preserved */
#mode-info-btn:active, .btn-clipboard:active{
  animation: anchored-btn-press 220ms ease-out;
}
</style>
</head>
<body>

<header>
  <img src="./mighty_mark_go.svg" alt="Pokémark" />
  <h1>Mächtige Pokémon</h1>
  <!--<h2>Mächtiger Suchstring</h2>-->
  <!--<p class="p-muted small">Mächtige Pokemon brauchen einen mächtigen Suchstring!</p>-->
  <div class="header-actions">
    <div class="card">
      <button class="btn-clipboard">Mächtiger Suchstring</button>
      <textarea id="output" readonly></textarea>
      <button id="mode-info-btn" class="btn">Info</button>
    </div>
  </div>
</header>

<script>
const TEMPLATE = `018,076,130,405,545,596,697,748,003,062,149,160,466,473,604,691,40,248,303,359,623,858,862,908,210,229,282,430,445,452,461,480-482,110,38,78&018,076,130,405,545,596,697,748,003,062,149,160,466,473,604,691,40,248,303,359,623,858,862,908,210,229,282,430,445,452,461,480-482,110,38,galar&018,076,130,405,545,596,697,748,003,062,149,160,466,473,604,691,40,248,303,359,623,858,862,908,210,229,282,430,445,452,461,480-482,110,alola,78&018,076,130,405,545,596,697,748,003,062,149,160,466,473,604,691,40,248,303,359,623,858,862,908,210,229,282,430,445,452,461,480-482,110,alola,galar&018,076,130,405,545,596,697,748,003,062,149,160,466,473,604,691,40,248,303,359,623,858,862,908,210,229,282,430,445,452,461,480-482,galar,38,78&018,076,130,405,545,596,697,748,003,062,149,160,466,473,604,691,40,248,303,359,623,858,862,908,210,229,282,430,445,452,461,480-482,galar,38&018,076,130,405,545,596,697,748,003,062,149,160,466,473,604,691,40,248,303,359,623,858,862,908,210,229,282,430,445,452,461,480-482,galar,alola,78&018,076,130,405,545,596,697,748,003,062,149,160,466,473,604,691,40,248,303,359,623,858,862,908,210,229,282,430,445,452,461,480-482,galar,alola&018,076,130,405,545,596,697,748,003,062,149,160,466,473,604,691,{{A25}}& {{A24}},40,248,303,359,623,858,862,908,210,229,282,430,445,452,461,480-482,110,38,78& {{A24}},40,248,303,359,623,858,862,908,210,229,282,430,445,452,461,480-482,110,38,galar& {{A24}},40,248,303,359,623,858,862,908,210,229,282,430,445,452,461,480-482,110,alola,78& {{A24}},40,248,303,359,623,858,862,908,210,229,282,430,445,452,461,480-482,110,alola,galar& {{A24}},40,248,303,359,623,858,862,908,210,229,282,430,445,452,461,480-482,galar,38,78& {{A24}},40,248,303,359,623,858,862,908,210,229,282,430,445,452,461,480-482,galar,38& {{A24}},40,248,303,359,623,858,862,908,210,229,282,430,445,452,461,480-482,galar,alola,78& {{A24}},40,248,303,359,623,858,862,908,210,229,282,430,445,452,461,480-482,galar,alola& {{A24}},{{A25}}`;

const EVENT24_START = new Date(Date.UTC(2024, 10, 23, 0, 0, 0));
const EVENT24_END   = new Date(Date.UTC(2024, 10, 24, 23, 59, 59));

const EVENT25_START = new Date(Date.UTC(2025, 10, 15, 0, 0, 0));
const EVENT25_END   = new Date(Date.UTC(2025, 10, 16, 23, 59, 59));

const output = document.getElementById('output');
const infoBtn = document.getElementById('mode-info-btn');

// Load the external SVG logo, inline it, and apply a slow "flame" morph using
// an SVG displacement filter (feTurbulence + feDisplacementMap). This affects
// the SVG path boundaries and animates them without changing the raster image
// boundary.
async function loadAndMorphSvg(){
  const img = document.querySelector('header img');
  if(!img) return;
  try{
    const res = await fetch(img.getAttribute('src'));
    if(!res.ok) return;
    const text = await res.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'image/svg+xml');
    const svg = doc.documentElement;
    // Normalize sizing so CSS width token applies
    svg.removeAttribute('width');
    svg.removeAttribute('height');
    svg.style.width = 'var(--header-control-effective)';
    svg.style.maxWidth = '92vw';

    const ns = 'http://www.w3.org/2000/svg';
    // Ensure we have a <defs> and a filter for displacement
    let defs = svg.querySelector('defs');
    if(!defs){ defs = document.createElementNS(ns,'defs'); svg.insertBefore(defs, svg.firstChild); }

    const filter = document.createElementNS(ns,'filter');
    filter.setAttribute('id','flame-filter');
    filter.setAttribute('primitiveUnits','userSpaceOnUse');

    const turb = document.createElementNS(ns,'feTurbulence');
    turb.setAttribute('type','fractalNoise');
    turb.setAttribute('baseFrequency','0.01 0.02');
    turb.setAttribute('numOctaves','2');
    turb.setAttribute('seed','7');
    turb.setAttribute('stitchTiles','noStitch');
    turb.setAttribute('result','noise');

    const disp = document.createElementNS(ns,'feDisplacementMap');
    disp.setAttribute('in','SourceGraphic');
    disp.setAttribute('in2','noise');
    disp.setAttribute('scale','12');
    disp.setAttribute('xChannelSelector','R');
    disp.setAttribute('yChannelSelector','G');

    filter.appendChild(turb);
    filter.appendChild(disp);
    defs.appendChild(filter);

    // Wrap visible children (after defs) into a group so we can apply the filter cleanly
    const g = document.createElementNS(ns,'g');
    // Move nodes that are not defs into the group
    const children = Array.from(svg.childNodes).filter(n => n.nodeType === 1 && n.nodeName.toLowerCase() !== 'defs');
    children.forEach(n => g.appendChild(n));
    svg.appendChild(g);
    g.setAttribute('filter','url(#flame-filter)');

    // Replace the <img> with the inlined SVG
    img.replaceWith(svg);

    // Animate the turbulence and displacement for a slow flame effect
    let t = 0;
    function step(){
      t += 0.008; // slow
      const f1 = 0.004 + Math.abs(Math.sin(t * 0.7)) * 0.01; // X frequency
      const f2 = 0.008 + Math.abs(Math.cos(t * 0.9)) * 0.012; // Y frequency
      turb.setAttribute('baseFrequency', `${f1} ${f2}`);
      const scale = 8 + Math.abs(Math.sin(t * 0.6)) * 14; // displacement scale
      disp.setAttribute('scale', String(scale));
      requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }catch(e){
    console.error('Failed to load/inline SVG', e);
  }
}

loadAndMorphSvg();

// NOTE: no global busy flag — button animations are reset on each click so
// rapid clicks are allowed while the visual success state is kept until
// the last timeout completes.

/* Info text previously shown in the popover — kept as a JS constant now */
const INFO_TEXT = `Füge den String in die Pokémon GO Suchleiste ein, um alle mächtigen Pokémon in deiner Sammlung zu finden.

Die Suchleiste von Pokémon GO erlaubt nur einfache AND-Verknüpfungen (&) und unterstützt keine Klammern oder OR-Logik (|). Jede Kombination aus Pokémon, Form und Fangalter muss daher einzeln aufgelistet werden, damit alle mächtigen Pokémon korrekt erfasst werden.

Mithilfe dieser disjunktiven Normalform (DNF) und einem automatischen Altersfilter entsteht ein sehr langer aber funktionaler Suchstring für mächtige Pokémon.`;

function daysSince(date){
  const msPerDay = 1000*60*60*24;
  return Math.floor((Date.now() - date.getTime())/msPerDay);
}

function buildRanges(){
  const min24 = daysSince(EVENT24_END);
  const max24 = daysSince(EVENT24_START);
  const r24 = `alter${min24}-${max24}`;
  const min25 = daysSince(EVENT25_END);
  const max25 = daysSince(EVENT25_START);
  const r25 = `alter${min25}-${max25}`;
  return { range24: r24, range25: r25 };
}

function generateFinalString(){
  const { range24, range25 } = buildRanges();
  return TEMPLATE.replaceAll("{{A24}}", range24).replaceAll("{{A25}}", range25)
    .split('&').map(g => g.trim().replace(/,+/g, ',').replace(/^,|,$/g, ''))
    .filter(g => g.length > 0).join('&').replace(/\s+/g, ' ');
}

let cachedString = '';
let _prevCachedString = null;

function renderPreview(){
  if(!output) return;
  cachedString = generateFinalString();
  output.value = cachedString;
  // if info was shown in the textarea, close that state and update the Info button label
  try{
    if(infoBtn && infoBtn.getAttribute('data-info-open') === 'true'){
      infoBtn.setAttribute('data-info-open','false');
      infoBtn.innerText = 'Info';
    }
  }catch(e){}
  requestAnimationFrame(() => { if(output) output.scrollTop = 0; });
}

let timer = null;

function scheduleMidnightUpdate(){
  if(timer) clearTimeout(timer);
  const now = new Date();
  const next = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0, 0);
  const ms = next.getTime() - now.getTime();
  timer = setTimeout(()=>{
    renderPreview();
    scheduleMidnightUpdate();
  }, ms + 1000);
}

function toggleModeInfo(){
  if(!infoBtn || !output) return;
  const isOpen = infoBtn.getAttribute('data-info-open') === 'true';

  if(!isOpen){
    _prevCachedString = cachedString;
    cachedString = INFO_TEXT;
    output.value = INFO_TEXT;
    requestAnimationFrame(()=>{ if(output) output.scrollTop = 0; });
    infoBtn.setAttribute('data-info-open', 'true');
    infoBtn.innerText = 'Zurück';
  } else {
    infoBtn.setAttribute('data-info-open', 'false');
    infoBtn.innerText = 'Info';
    if(_prevCachedString !== null){
      cachedString = _prevCachedString;
      _prevCachedString = null;
      output.value = cachedString;
      requestAnimationFrame(()=>{ if(output) output.scrollTop = 0; });
    } else {
      renderPreview();
    }
  }
}

function _setButtonState(btn, text, state){
  if(!btn) return;
  if(btn._timeout) clearTimeout(btn._timeout);
  if(!btn._origText) btn._origText = btn.innerText;
  // we don't change or rely on `disabled` here — allow repeated clicks.

  // preserve the button's current layout size so short temporary labels (like "✓")
  // don't cause the button to shrink. Store existing inline minHeight to restore later.
  try{
    if(!btn._savedMinHeight){
      btn._savedMinHeight = btn.style.minHeight || '';
      const rect = btn.getBoundingClientRect();
      if(rect && rect.height){
        btn.style.minHeight = rect.height + 'px';
      }
    }
  }catch(e){}

  // Update label and restart the visual animation for the requested state.
  btn.innerText = text;
  // remove any previous state classes first
  btn.classList.remove('success','error');
  if(state){
    // force-animation-restart: clear inline animation, force reflow, then add class
    btn.style.animation = 'none';
    // read a layout property to flush style changes
    void btn.offsetWidth;
    btn.classList.add(state);
    // allow future CSS animations to run normally
    btn.style.animation = '';
  }
  
  const ms = btn.classList.contains('btn-clipboard') ? 300 : 360;
  btn._timeout = setTimeout(()=>{
    // restore original text and any preserved minHeight
    btn.innerText = btn._origText;
    btn.classList.remove('success','error');
    try{
      if(btn._savedMinHeight !== undefined){
        btn.style.minHeight = btn._savedMinHeight || '';
        delete btn._savedMinHeight;
      }
    }catch(e){}
    delete btn._timeout;
  }, ms);
}

function copyAndNotify(btn){
  const button = btn || document.querySelector('.btn-clipboard');
  navigator.clipboard.writeText(cachedString || generateFinalString()).then(()=>{
    renderPreview();
    _setButtonState(button, '✓', 'success');
  }, ()=>{
    _setButtonState(button, 'Kopieren fehlgeschlagen', 'error');
  });
}

// Attach event listeners instead of using inline onclick attributes. Listeners
// check `uiBusy` and will ignore clicks while busy.
const _attachUIListeners = ()=>{
  const clipboardEl = document.querySelector('.btn-clipboard');
  if(clipboardEl){
    clipboardEl.addEventListener('click', (e)=>{
      copyAndNotify(clipboardEl);
    });
  }
  if(infoBtn){
    infoBtn.addEventListener('click', (e)=>{
      toggleModeInfo();
    });
  }
};

_attachUIListeners();


renderPreview();
scheduleMidnightUpdate();

document.addEventListener('visibilitychange', ()=>{
  if(!document.hidden){
    renderPreview();
    scheduleMidnightUpdate();
  }
});
</script>

</body>
</html>
